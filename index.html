<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graduation Line Dash</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            background-color: #f0f9ff;
            touch-action: none; /* Prevent zooming on mobile */
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            max-width: 800px; /* Keep game constraint reasonable on large screens */
            margin: 0 auto;
            background: #e0f2fe;
            border: 2px solid #bae6fd;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 20;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* The Premium Skip Button */
        #skip-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 10;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
            border: 2px solid white;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.3s;
            animation: pulse 2s infinite;
        }

        #skip-btn:active {
            transform: scale(0.95);
        }

        #skip-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            animation: none;
            background: #9ca3af;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Input error shake animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        /* Progress Bar */
        #progress-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 12px;
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #3b82f6;
            z-index: 10;
        }

        #progress-fill {
            height: 100%;
            width: 0%;
            background: #3b82f6;
            transition: width 0.1s linear;
        }

        .particle {
            position: absolute;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(0); opacity: 0; }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <!-- Canvas -->
        <canvas id="gameCanvas"></canvas>

        <!-- UI: Progress -->
        <div id="progress-container">
            <div id="progress-fill"></div>
        </div>

        <!-- UI: Skip Button -->
        <button id="skip-btn" onclick="activateSkipService()">
            ‚ö° HIRE SKIPTHEWAIT!
        </button>

        <!-- Screen: Start -->
        <div id="start-screen" class="overlay">
            <h1 class="text-4xl font-bold text-blue-900 mb-2">Graduation Line Dash</h1>
            <p class="text-gray-600 mb-6 text-lg">Don't be late for your photo!</p>
            
            <!-- NEW EMAIL CAPTURE SECTION -->
            <div class="w-full max-w-sm mb-6 p-4 bg-gray-50 rounded-xl shadow-md border border-gray-200">
                <label for="email-input" class="block text-sm font-medium text-gray-700 mb-2">Enter your email to secure your spot:</label>
                <input type="email" id="email-input" placeholder="you@university.edu" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-900" 
                       required>
                <p id="email-error" class="text-sm text-red-500 mt-2 hidden">Please enter a valid email address.</p>
            </div>
            
            <div class="flex gap-4 items-center mb-8">
                <div class="bg-white p-4 rounded-xl shadow-md border border-gray-100">
                    <span class="text-3xl">üéì</span>
                    <p class="text-xs font-bold text-gray-500 mt-2">YOU</p>
                </div>
                <div class="text-gray-400">vs</div>
                <div class="bg-white p-4 rounded-xl shadow-md border border-gray-100">
                    <span class="text-3xl">üßç</span>
                    <p class="text-xs font-bold text-gray-500 mt-2">THE LINE</p>
                </div>
            </div>
            <p class="text-sm text-gray-500 mb-6">Spacebar or Tap to Jump (After signing up)</p>
            <button onclick="handleStartGame()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg transition transform hover:scale-105">
                JOIN THE LINE
            </button>
        </div>

        <!-- Screen: Game Over -->
        <div id="game-over-screen" class="overlay hidden">
            <h2 class="text-3xl font-bold text-red-500 mb-2">Wait Time: ‚àû</h2>
            <p class="text-gray-700 mb-6">You got stuck behind someone asking too many questions.</p>
            <button onclick="resetGame()" class="bg-gray-800 text-white font-bold py-2 px-6 rounded-full mb-4">
                Try Again
            </button>
            <div class="mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200 max-w-xs">
                <p class="text-sm text-yellow-800 font-semibold">üí° Pro Tip:</p>
                <p class="text-xs text-yellow-700">Use the "Hire SkipTheWait" button to skip the line instantly!</p>
            </div>
            
            <!-- NEW BUTTON FOR SIGN UP -->
            <div class="mt-8">
                <button class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-indigo-700 transition transform hover:scale-105">
                    Sign up for SkipTheWait
                </button>
            </div>
        </div>

        <!-- Screen: Win -->
        <div id="win-screen" class="overlay hidden">
            <h2 class="text-3xl font-bold text-green-600 mb-2">üì∏ FLASH!</h2>
            <p class="text-gray-700 mb-6 text-lg">You made it to the front!</p>
            
            <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 max-w-sm">
                <h3 class="font-bold text-blue-900 mb-2">Tired of playing games?</h3>
                <p class="text-sm text-gray-600 mb-4">
                    In real life, you can't jump over people. But we can wait for you.
                </p>
                <!-- UPDATED BUTTON TEXT -->
                <button class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">
                    Sign up for SkipTheWait
                </button>
            </div>
            
            <button onclick="resetGame()" class="mt-6 text-gray-500 text-sm hover:underline">
                Play Again
            </button>
        </div>
    </div>

    <script>
        // --- Setup ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('game-container');
        
        let width, height;
        
        // Game State
        let gameRunning = false;
        let frameId;
        let score = 0;
        let distance = 0;
        const GOAL_DISTANCE = 24000; // Distance to run (Doubled again for maximum tedium!)
        
        // Physics
        let gameSpeed = 5;
        const gravity = 0.6;
        const jumpStrength = -12;
        
        // Player
        const player = {
            x: 50,
            y: 0,
            width: 40,
            height: 40,
            dy: 0,
            grounded: false,
            emoji: 'üéì',
            isSkipping: false
        };

        // Obstacles
        let obstacles = [];
        let nextObstacleTimer = 0;

        // Visuals
        let particles = [];
        let bgOffset = 0;

        // The URL for the Google Apps Script Web App (MUST BE REPLACED)
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKJSJPU462sO7tAeSW6N-Nm6-gcS43KacE-_zJ-FGNquTslCvGLkjSrRqeXkpUzZj4Rg/exec';


        // --- Resizing ---
        function resize() {
            width = container.clientWidth;
            height = container.clientHeight;
            canvas.width = width;
            canvas.height = height;
            // Keep player on ground if resized
            if (!gameRunning) player.y = height - 100;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- Controls ---
        function jump() {
            if (gameRunning && player.grounded) {
                player.dy = jumpStrength;
                player.grounded = false;
                createParticle(player.x + 20, player.y + 40, 'üí®');
            }
        }

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') jump();
        });
        
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            jump();
        }, {passive: false});

        canvas.addEventListener('mousedown', (e) => {
            jump();
        });

        // --- Game Logic ---

        function spawnObstacle() {
            // Randomize obstacle type
            const types = ['üßç', 'üßç‚Äç‚ôÄÔ∏è', 'üö∂', 'üßç‚Äç‚ôÇÔ∏è'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            obstacles.push({
                x: width,
                y: height - 90, // Ground level offset
                width: 30,
                height: 50,
                emoji: type,
                passed: false
            });
        }

        function createParticle(x, y, char) {
            particles.push({
                x, y, char,
                life: 30,
                dx: (Math.random() - 0.5) * 2,
                dy: -Math.random() * 2
            });
        }

        function activateSkipService() {
            if (!gameRunning || player.isSkipping) return;

            const btn = document.getElementById('skip-btn');
            btn.disabled = true;
            btn.innerHTML = "üöÄ SKIPPING...";
            btn.classList.add('bg-purple-600');

            player.isSkipping = true;
            gameSpeed = 60; // Set super high speed for visual effect

            // Visual flair
            for(let i=0; i<10; i++) {
                setTimeout(() => createParticle(Math.random() * width, Math.random() * height, '‚ú®'), i*100);
            }

            // The update() function will now quickly accelerate 
            // the distance and trigger the win condition naturally when distance >= GOAL_DISTANCE.
        }
        
        // --- NEW FUNCTION: Validate email and Submit to Google Sheets ---
        async function handleStartGame() {
            const emailInput = document.getElementById('email-input');
            const emailError = document.getElementById('email-error');
            const startButton = document.querySelector('#start-screen button');
            const email = emailInput.value.trim();

            if (email === "") {
                emailError.classList.remove('hidden');
                // Simple visual shake effect for feedback
                emailInput.style.animation = 'shake 0.5s';
                emailInput.onanimationend = () => emailInput.style.animation = '';
                return;
            }

            // Remove error message and disable button while submitting
            emailError.classList.add('hidden');
            startButton.disabled = true;
            startButton.textContent = 'Submitting...';
            
            // Prepare data for submission
            const data = {
                email: email,
                timestamp: new Date().toISOString()
            };
            const formBody = Object.keys(data).map(key => encodeURIComponent(key) + '=' + encodeURIComponent(data[key])).join('&');


            // 1. Send data to Google Apps Script Web App
            if (APPS_SCRIPT_URL.includes('YOUR_APPS_SCRIPT_WEB_APP_URL')) {
                console.error("ALERT: Please replace 'YOUR_APPS_SCRIPT_WEB_APP_URL' with your actual deployed script URL.");
                // Fallback to starting the game without submitting
            } else {
                try {
                    // Using POST request to simulate a form submission
                    await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Essential for Google Apps Script to work correctly
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: formBody
                    });
                    console.log(`Email successfully submitted: ${email}`);
                } catch (e) {
                    console.error("Failed to submit email (Check network/CORS settings):", e);
                }
            }

            // Re-enable button and start the game
            startButton.disabled = false;
            startButton.textContent = 'JOIN THE LINE';
            startGame();
        }

        function update() {
            // Player Physics
            player.dy += gravity;
            player.y += player.dy;

            const groundLevel = height - 90;

            if (player.y > groundLevel) {
                player.y = groundLevel;
                player.dy = 0;
                player.grounded = true;
            }

            // Distance & Progression
            distance += gameSpeed;
            const progress = Math.min((distance / GOAL_DISTANCE) * 100, 100);
            document.getElementById('progress-fill').style.width = `${progress}%`;

            // Win Condition
            if (distance >= GOAL_DISTANCE) {
                gameOver(true);
                return;
            }

            // Obstacle Logic
            nextObstacleTimer--;
            if (nextObstacleTimer <= 0 && !player.isSkipping) {
                spawnObstacle();
                // Increased density: reduced the gap between spawns (now 30 to 130 frames)
                nextObstacleTimer = Math.random() * 100 + 30; 
            }

            // Move Obstacles
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obs = obstacles[i];
                obs.x -= gameSpeed;

                // Collision Detection
                // Collisions are ignored when skipping (player.isSkipping is true)
                if (!player.isSkipping && 
                    player.x < obs.x + obs.width &&
                    player.x + player.width > obs.x &&
                    player.y < obs.y + obs.height &&
                    player.y + player.height > obs.y) {
                    
                    gameOver(false);
                    return;
                }

                // Cleanup
                if (obs.x + obs.width < 0) {
                    obstacles.splice(i, 1);
                }
            }

            // Update Particles
            particles.forEach((p, i) => {
                p.x += p.dx;
                p.y += p.dy;
                p.life--;
                if(p.life <= 0) particles.splice(i, 1);
            });
        }

        function draw() {
            // Clear Canvas
            ctx.clearRect(0, 0, width, height);

            // Draw Sky/Bg
            ctx.fillStyle = player.isSkipping ? '#eef2ff' : '#e0f2fe';
            ctx.fillRect(0, 0, width, height);

            // Draw Moving Clouds (Parallax)
            bgOffset -= gameSpeed * 0.2;
            ctx.fillStyle = 'white';
            ctx.globalAlpha = 0.6;
            ctx.font = '40px Arial';
            // Use the modulus operator to loop the clouds horizontally
            ctx.fillText('‚òÅÔ∏è', ((bgOffset % width) + width) % width, 100);
            ctx.fillText('‚òÅÔ∏è', (((bgOffset + 400) % width) + width) % width, 50);
            ctx.fillText('‚òÅÔ∏è', (((bgOffset + 800) % width) + width) % width, 120);
            ctx.globalAlpha = 1.0;

            // Draw Ground
            ctx.fillStyle = '#86efac'; // Green grass
            ctx.fillRect(0, height - 50, width, 50);
            ctx.strokeStyle = '#4ade80';
            ctx.beginPath();
            ctx.moveTo(0, height - 50);
            ctx.lineTo(width, height - 50);
            ctx.stroke();

            // Draw Decor (Trees/Buildings) in background
            const patternWidth = 800;
            // Calculate the horizontal offset. The negative sign makes it scroll left.
            // % patternWidth keeps it looping between 0 and -799.99...
            let scrollOffset = -(distance * 0.5) % patternWidth;
            
            // Draw the pattern once starting at `scrollOffset` and again at `scrollOffset + patternWidth`
            // to ensure continuous scrolling and seamless tiling across the whole screen.
            [scrollOffset, scrollOffset + patternWidth].forEach(x => {
                ctx.font = '60px Arial';
                // Trees: Draw at base X + 200
                ctx.fillText('üå≥', x + 200, height - 50); 
                // School: Draw at base X + 600
                ctx.fillText('üè´', x + 600, height - 50);
            });

            // Draw Obstacles
            obstacles.forEach(obs => {
                ctx.font = '40px Arial';
                ctx.fillText(obs.emoji, obs.x, obs.y + 40);
            });

            // Draw Player
            ctx.save();
            if (player.isSkipping) {
                // Blur effect for speed
                ctx.shadowBlur = 10;
                ctx.shadowColor = "purple";
                ctx.globalAlpha = 0.8;
                ctx.fillText('üí®', player.x - 30, player.y + 40);
            }
            ctx.font = '40px Arial';
            ctx.fillText(player.emoji, player.x, player.y + 40);
            ctx.restore();

            // Draw Goal (Photographer) if close
            if (GOAL_DISTANCE - distance < width) {
                let goalX = (GOAL_DISTANCE - distance) + player.x; // approximate relative pos
                ctx.font = '50px Arial';
                ctx.fillText('üì∏', goalX, height - 60);
                ctx.fillText('üèÅ', goalX + 10, height - 100);
            }

            // Draw Particles
            particles.forEach(p => {
                ctx.font = '20px Arial';
                ctx.globalAlpha = p.life / 30;
                ctx.fillText(p.char, p.x, p.y);
            });
            ctx.globalAlpha = 1.0;
        }

        function loop() {
            if (!gameRunning) return;
            update();
            draw();
            frameId = requestAnimationFrame(loop);
        }

        // --- UI Functions ---

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('win-screen').classList.add('hidden');
            document.getElementById('skip-btn').disabled = false;
            document.getElementById('skip-btn').innerHTML = "‚ö° HIRE SKIPTHEWAIT!";
            document.getElementById('skip-btn').classList.remove('bg-purple-600');
            document.getElementById('skip-btn').style.display = 'block';
            
            resetGameVars();
            gameRunning = true;
            loop();
        }

        function resetGameVars() {
            player.y = height - 90;
            player.dy = 0;
            player.isSkipping = false;
            obstacles = [];
            score = 0;
            distance = 0;
            gameSpeed = 5;
            nextObstacleTimer = 0;
            document.getElementById('progress-fill').style.width = '0%';
        }

        function gameOver(win) {
            gameRunning = false;
            cancelAnimationFrame(frameId);
            document.getElementById('skip-btn').style.display = 'none';

            if (win) {
                document.getElementById('win-screen').classList.remove('hidden');
            } else {
                document.getElementById('game-over-screen').classList.remove('hidden');
            }
        }

        function resetGame() {
            // When resetting, we go back to the start screen to re-capture the email (or allow user to start)
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('win-screen').classList.add('hidden');
            resetGameVars();
        }

        // Initial Draw
        resize();
        
    </script>
</body>
</html>

